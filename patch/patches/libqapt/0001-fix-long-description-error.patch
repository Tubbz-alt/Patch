From a468ea333dc5bd5f4955812005c7fcacf436e1ca Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E7=9F=B3=E5=8D=9A=E6=96=87?= <sbw@sbw.so>
Date: Fri, 28 Jul 2017 14:37:38 +0800
Subject: [PATCH] fix long description error

---
 .gitignore      |  1 +
 src/debfile.cpp | 39 ++++++++++++++-------------------------
 2 files changed, 15 insertions(+), 25 deletions(-)

diff --git a/.gitignore b/.gitignore
index 31252ef..7cdeac9 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,3 +1,4 @@
 *.kdev4
 my*
 build
+CMakeList*.user
diff --git a/src/debfile.cpp b/src/debfile.cpp
index bf29b32..b00ee9b 100644
--- a/src/debfile.cpp
+++ b/src/debfile.cpp
@@ -24,6 +24,7 @@
 #include <QtCore/QProcess>
 #include <QtCore/QStringBuilder>
 #include <QtCore/QTemporaryFile>
+#include <QtCore/QRegularExpression>
 
 #include <apt-pkg/debfile.h>
 #include <apt-pkg/fileutl.h>
@@ -143,38 +144,26 @@ QString DebFile::homepage() const
 
 QString DebFile::longDescription() const
 {
-    QString rawDescription = QLatin1String(d->controlData->FindS("Description").c_str());
-    // Remove short description
-    rawDescription.remove(shortDescription() + '\n');
+    QString rawDescription = QString(d->controlData->FindS("Description").c_str());
 
     QString parsedDescription;
     // Split at double newline, by "section"
-    QStringList sections = rawDescription.split(QLatin1String("\n ."));
-
-    for (int i = 0; i < sections.count(); ++i) {
-        sections[i].replace(QRegExp(QLatin1String("\n( |\t)+(-|\\*)")),
-                                QLatin1Literal("\n\r ") % QString::fromUtf8("\xE2\x80\xA2"));
-        // There should be no new lines within a section.
-        sections[i].remove(QLatin1Char('\n'));
-        // Hack to get the lists working again.
-        sections[i].replace(QLatin1Char('\r'), QLatin1Char('\n'));
-        // Merge multiple whitespace chars into one
-        sections[i].replace(QRegExp(QLatin1String("\\ \\ +")), QChar::fromLatin1(' '));
-        // Remove the initial whitespace
-        sections[i].remove(0, 1);
-        // Append to parsedDescription
-        if (sections[i].startsWith(QLatin1String("\n ") % QString::fromUtf8("\xE2\x80\xA2 ")) || !i) {
-            parsedDescription += sections[i];
-        }  else {
-            parsedDescription += QLatin1Literal("\n\n") % sections[i];
-        }
-    }
-    return parsedDescription;
+    const QStringList sections = rawDescription.split("\n ");
+
+    // starts from 1, pass short description.
+    for (int i = 1; i < sections.count(); ++i)
+        parsedDescription.append(sections[i]);
+    parsedDescription.replace(QRegularExpression("[\r\n]+", QRegularExpression::MultilineOption), "\n");
+
+    if (!parsedDescription.isEmpty())
+        return parsedDescription;
+    else
+        return shortDescription();
 }
 
 QString DebFile::shortDescription() const
 {
-    QString longDesc = QLatin1String(d->controlData->FindS("Description").c_str());
+    QString longDesc(d->controlData->FindS("Description").c_str());
 
     return longDesc.left(longDesc.indexOf(QLatin1Char('\n')));
 }
-- 
2.11.0

